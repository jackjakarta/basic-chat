'use client';

import { useToast } from '@/components/hooks/use-toast';
import { type ActiveIntegration } from '@/db/functions/data-source-integrations';
import { DataSourceIntegrationModel } from '@/db/schema';
import { cw } from '@/utils/tailwind';
import { useRouter } from 'next/navigation';
import React from 'react';

import { removeDataSourceIntegrationAction } from './actions';
import { NotionIcon } from './icons';

export function getLoginByDataSourceIntegration(dataSourceIntegration: DataSourceIntegrationModel) {
  if (dataSourceIntegration.type === 'notion') {
    return { redirectUri: '/api/auth/notion/login' };
  }

  return undefined;
}

type IntegrationCardProps = DataSourceIntegrationModel & {
  activeIntegration?: ActiveIntegration | undefined;
};

export default function IntegrationCard({
  activeIntegration,
  ...dataSourceIntegration
}: IntegrationCardProps) {
  const { name, state, type, description } = dataSourceIntegration;
  const { toastSuccess, toastError } = useToast();
  const router = useRouter();

  async function handleClick() {
    if (activeIntegration === undefined) {
      const loginData = getLoginByDataSourceIntegration(dataSourceIntegration);

      if (loginData === undefined) {
        toastError('Something went wrong when activating the integration.');
        return;
      }
      window.open(loginData.redirectUri);
      return;
    }

    if (activeIntegration !== undefined) {
      const deleted = await removeDataSourceIntegrationAction({
        dataSourceIntegrationId: dataSourceIntegration.id,
      });

      if (deleted !== undefined) {
        toastSuccess(
          `The integration with ${activeIntegration.name} was successfully disconnected.`,
        );
      } else {
        toastSuccess(
          `Something went wrong with the separation of the ${activeIntegration.name} integration.`,
        );
      }
      router.refresh();
    }
  }

  return (
    <button
      title="Connect/Disconnect with integration"
      className={cw(
        'border border-grey-400 p-4 grid grid-cols-[auto_1fr_auto] rounded-lg w-full gap-4 hover:bg-primary/10',
        state === 'comingSoon' && 'bg-gray-200 border-grey-600',
        state === 'active' && 'group hover:cursor-pointer',
      )}
      onClick={handleClick}
    >
      <IntegrationIcon type={type} />
      <div className="flex flex-col gap-3 text-left">
        <div className="flex items-center gap-2">
          <h2 className="font-medium">{name}</h2>
          {state === 'comingSoon' && (
            <span className="text-[#453A09] text-sm px-1 pt-0.5 bg-yellow-300">Coming soon</span>
          )}
          {activeIntegration !== undefined && (
            <span className="bg-[#31E38A1A] text-green-600 rounded-lg text-sm py-1 px-2">
              Active
            </span>
          )}
        </div>
        <p className="text-secondary-foreground/70 dark:text-primary-foreground/60 text-base">
          {description}
        </p>
      </div>
      {activeIntegration === undefined && <ConnectIcon className="rounded-lg" />}
      {activeIntegration !== undefined && <RemoveConnectionIcon className="rounded-lg" />}
    </button>
  );
}

function RemoveConnectionIcon(props: React.ComponentProps<'svg'>) {
  return (
    <svg
      width="40"
      height="40"
      viewBox="0 0 44 44"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      {...props}
    >
      <path
        d="M30.5675 13.4333C30.5095 13.3752 30.4406 13.3291 30.3647 13.2976C30.2888 13.2662 30.2075 13.25 30.1253 13.25C30.0432 13.25 29.9619 13.2662 29.886 13.2976C29.8101 13.3291 29.7412 13.3752 29.6832 13.4333L25.5894 17.5278L25.1699 17.1075C24.7005 16.6395 24.0647 16.3767 23.4019 16.3767C22.7391 16.3767 22.1033 16.6395 21.6339 17.1075L19.8128 18.9294L19.3175 18.4333C19.2003 18.316 19.0412 18.2501 18.8753 18.2501C18.7095 18.2501 18.5504 18.316 18.4332 18.4333C18.3159 18.5506 18.25 18.7096 18.25 18.8755C18.25 19.0413 18.3159 19.2004 18.4332 19.3177L18.9293 19.813L17.1074 21.6341C16.8752 21.8662 16.691 22.1419 16.5653 22.4452C16.4396 22.7486 16.3749 23.0737 16.3749 23.4021C16.3749 23.7304 16.4396 24.0555 16.5653 24.3589C16.691 24.6622 16.8752 24.9379 17.1074 25.17L17.5277 25.5896L13.4332 29.6833C13.3751 29.7414 13.329 29.8103 13.2976 29.8862C13.2662 29.9621 13.25 30.0434 13.25 30.1255C13.25 30.2076 13.2662 30.2889 13.2976 30.3648C13.329 30.4407 13.3751 30.5096 13.4332 30.5677C13.5504 30.685 13.7095 30.7508 13.8753 30.7508C13.9575 30.7508 14.0388 30.7347 14.1147 30.7032C14.1905 30.6718 14.2595 30.6257 14.3175 30.5677L18.4113 26.4731L18.8308 26.8935C19.063 27.1257 19.3386 27.3099 19.6419 27.4355C19.9453 27.5612 20.2704 27.6259 20.5988 27.6259C20.9271 27.6259 21.2523 27.5612 21.5556 27.4355C21.859 27.3099 22.1346 27.1257 22.3668 26.8935L24.1878 25.0716L24.6832 25.5677C24.7412 25.6257 24.8102 25.6718 24.886 25.7032C24.9619 25.7347 25.0432 25.7508 25.1253 25.7508C25.2075 25.7508 25.2888 25.7347 25.3647 25.7032C25.4405 25.6718 25.5095 25.6257 25.5675 25.5677C25.6256 25.5096 25.6717 25.4407 25.7031 25.3648C25.7345 25.2889 25.7507 25.2076 25.7507 25.1255C25.7507 25.0434 25.7345 24.9621 25.7031 24.8862C25.6717 24.8103 25.6256 24.7414 25.5675 24.6833L25.0714 24.188L26.8933 22.3669C27.1255 22.1347 27.3097 21.8591 27.4354 21.5558C27.5611 21.2524 27.6258 20.9273 27.6258 20.5989C27.6258 20.2706 27.5611 19.9454 27.4354 19.6421C27.3097 19.3387 27.1255 19.0631 26.8933 18.831L26.473 18.4114L30.5675 14.3177C30.6256 14.2596 30.6717 14.1907 30.7032 14.1148C30.7347 14.039 30.7508 13.9576 30.7508 13.8755C30.7508 13.7934 30.7347 13.712 30.7032 13.6362C30.6717 13.5603 30.6256 13.4913 30.5675 13.4333ZM21.4824 26.0114C21.248 26.2457 20.9302 26.3773 20.5988 26.3773C20.2674 26.3773 19.9496 26.2457 19.7152 26.0114L17.9918 24.2856C17.7575 24.0513 17.6259 23.7334 17.6259 23.4021C17.6259 23.0707 17.7575 22.7529 17.9918 22.5185L19.8128 20.6966L23.3043 24.188L21.4824 26.0114ZM26.0089 21.4849L24.1878 23.3044L20.6964 19.813L22.5183 17.9919C22.7527 17.7577 23.0705 17.6261 23.4019 17.6261C23.7333 17.6261 24.0511 17.7577 24.2855 17.9919L26.0089 19.7106C26.1256 19.8268 26.2182 19.9649 26.2814 20.1169C26.3446 20.2689 26.3771 20.4319 26.3771 20.5966C26.3771 20.7612 26.3446 20.9242 26.2814 21.0763C26.2182 21.2283 26.1256 21.3664 26.0089 21.4825V21.4849ZM18.9199 14.7349C18.8577 14.5809 18.8593 14.4086 18.9242 14.2558C18.9891 14.103 19.112 13.9822 19.266 13.92C19.4199 13.8579 19.5923 13.8594 19.7451 13.9243C19.8979 13.9892 20.0187 14.1122 20.0808 14.2661L20.7058 15.8286C20.7366 15.9048 20.7521 15.9864 20.7513 16.0686C20.7506 16.1508 20.7337 16.2321 20.7015 16.3077C20.6694 16.3834 20.6227 16.452 20.564 16.5096C20.5054 16.5672 20.436 16.6127 20.3597 16.6435C20.2835 16.6742 20.202 16.6897 20.1197 16.689C20.0375 16.6882 19.9563 16.6713 19.8806 16.6392C19.805 16.607 19.7364 16.5603 19.6788 16.5017C19.6211 16.443 19.5757 16.3736 19.5449 16.2974L18.9199 14.7349ZM13.9199 19.2661C13.9505 19.1898 13.996 19.1203 14.0536 19.0616C14.1112 19.0029 14.1798 18.9561 14.2555 18.9239C14.3312 18.8918 14.4125 18.8749 14.4947 18.8742C14.5769 18.8735 14.6585 18.8891 14.7347 18.92L16.2972 19.545C16.3735 19.5758 16.4429 19.6213 16.5015 19.6789C16.5602 19.7365 16.6069 19.8051 16.639 19.8808C16.6712 19.9564 16.6881 20.0377 16.6888 20.1199C16.6896 20.2021 16.6741 20.2836 16.6433 20.3599C16.6125 20.4361 16.567 20.5055 16.5094 20.5642C16.4518 20.6228 16.3832 20.6695 16.3076 20.7017C16.2319 20.7338 16.1507 20.7507 16.0684 20.7515C15.9862 20.7522 15.9047 20.7367 15.8285 20.706L14.266 20.081C14.1897 20.0503 14.1202 20.0049 14.0614 19.9473C14.0027 19.8897 13.9559 19.8211 13.9238 19.7454C13.8916 19.6697 13.8747 19.5884 13.8741 19.5061C13.8734 19.4239 13.889 19.3423 13.9199 19.2661ZM30.0808 24.7349C30.0504 24.8111 30.0052 24.8806 29.9479 24.9394C29.8905 24.9981 29.8222 25.045 29.7468 25.0774C29.6713 25.1098 29.5902 25.1269 29.5081 25.128C29.426 25.129 29.3445 25.1138 29.2683 25.0833L27.7058 24.4583C27.6294 24.4277 27.5598 24.3823 27.501 24.3248C27.4421 24.2673 27.3952 24.1987 27.3628 24.123C27.3305 24.0474 27.3133 23.9661 27.3124 23.8838C27.3115 23.8015 27.3268 23.7198 27.3574 23.6435C27.388 23.5671 27.4334 23.4975 27.4909 23.4386C27.5484 23.3798 27.617 23.3328 27.6926 23.3005C27.7683 23.2681 27.8496 23.251 27.9319 23.2501C28.0142 23.2491 28.0958 23.2644 28.1722 23.295L29.7347 23.92C29.811 23.9507 29.8805 23.9961 29.9393 24.0537C29.998 24.1113 30.0448 24.1799 30.0769 24.2556C30.1091 24.3313 30.126 24.4126 30.1266 24.4948C30.1273 24.5771 30.1117 24.6587 30.0808 24.7349ZM25.0808 29.2708C25.1113 29.347 25.1264 29.4285 25.1254 29.5106C25.1244 29.5927 25.1072 29.6738 25.0749 29.7492C25.0425 29.8247 24.9956 29.893 24.9369 29.9503C24.8781 30.0076 24.8086 30.0528 24.7324 30.0833C24.6562 30.1138 24.5747 30.1289 24.4926 30.1279C24.4105 30.1269 24.3294 30.1097 24.254 30.0774C24.1785 30.045 24.1102 29.9981 24.0529 29.9393C23.9955 29.8806 23.9504 29.8111 23.9199 29.7349L23.2949 28.1724C23.2327 28.0184 23.2343 27.8461 23.2992 27.6933C23.3641 27.5405 23.487 27.4197 23.641 27.3575C23.7949 27.2954 23.9673 27.2969 24.1201 27.3618C24.2729 27.4267 24.3937 27.5497 24.4558 27.7036L25.0808 29.2708Z"
        fill="#E4252B"
      />
    </svg>
  );
}

function ConnectIcon(props: React.ComponentProps<'svg'>) {
  return (
    <svg
      width="40"
      height="40"
      viewBox="0 0 44 44"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      {...props}
    >
      <path
        d="M23.6925 22.8083C23.6345 22.7502 23.5656 22.7041 23.4897 22.6726C23.4138 22.6412 23.3325 22.625 23.2503 22.625C23.1682 22.625 23.0869 22.6412 23.011 22.6726C22.9351 22.7041 22.8662 22.7502 22.8082 22.8083L21.3753 24.2419L19.7589 22.6255L21.1925 21.1927C21.3098 21.0754 21.3757 20.9163 21.3757 20.7505C21.3757 20.5846 21.3098 20.4256 21.1925 20.3083C21.0753 20.191 20.9162 20.1251 20.7503 20.1251C20.5845 20.1251 20.4254 20.191 20.3082 20.3083L18.8753 21.7419L17.4425 20.3083C17.3253 20.191 17.1662 20.1251 17.0003 20.1251C16.8345 20.1251 16.6754 20.191 16.5582 20.3083C16.4409 20.4256 16.375 20.5846 16.375 20.7505C16.375 20.9163 16.4409 21.0754 16.5582 21.1927L17.0543 21.688L15.2324 23.5091C15.0002 23.7412 14.816 24.0169 14.6903 24.3202C14.5646 24.6236 14.4999 24.9487 14.4999 25.2771C14.4999 25.6054 14.5646 25.9305 14.6903 26.2339C14.816 26.5372 15.0002 26.8129 15.2324 27.045L15.6527 27.4646L13.4332 29.6833C13.3751 29.7414 13.329 29.8103 13.2976 29.8862C13.2662 29.9621 13.25 30.0434 13.25 30.1255C13.25 30.2076 13.2662 30.2889 13.2976 30.3648C13.329 30.4407 13.3751 30.5096 13.4332 30.5677C13.5504 30.685 13.7095 30.7508 13.8753 30.7508C13.9575 30.7508 14.0388 30.7347 14.1147 30.7032C14.1905 30.6718 14.2595 30.6257 14.3175 30.5677L16.5363 28.3481L16.9558 28.7685C17.188 29.0007 17.4636 29.1849 17.7669 29.3105C18.0703 29.4362 18.3954 29.5009 18.7238 29.5009C19.0521 29.5009 19.3773 29.4362 19.6806 29.3105C19.984 29.1849 20.2596 29.0007 20.4918 28.7685L22.3128 26.9466L22.8082 27.4427C22.8662 27.5007 22.9352 27.5468 23.011 27.5782C23.0869 27.6097 23.1682 27.6258 23.2503 27.6258C23.3325 27.6258 23.4138 27.6097 23.4897 27.5782C23.5655 27.5468 23.6345 27.5007 23.6925 27.4427C23.7506 27.3846 23.7967 27.3157 23.8281 27.2398C23.8595 27.1639 23.8757 27.0826 23.8757 27.0005C23.8757 26.9184 23.8595 26.8371 23.8281 26.7612C23.7967 26.6853 23.7506 26.6164 23.6925 26.5583L22.2589 25.1255L23.6925 23.6927C23.7506 23.6346 23.7967 23.5657 23.8282 23.4898C23.8597 23.414 23.8758 23.3326 23.8758 23.2505C23.8758 23.1684 23.8597 23.087 23.8282 23.0112C23.7967 22.9353 23.7506 22.8663 23.6925 22.8083ZM19.6074 27.8864C19.373 28.1207 19.0552 28.2523 18.7238 28.2523C18.3924 28.2523 18.0746 28.1207 17.8402 27.8864L16.1168 26.1606C15.8825 25.9263 15.7509 25.6084 15.7509 25.2771C15.7509 24.9457 15.8825 24.6279 16.1168 24.3935L17.9378 22.5716L21.4293 26.063L19.6074 27.8864ZM30.5675 13.4333C30.5095 13.3752 30.4406 13.3291 30.3647 13.2976C30.2888 13.2662 30.2075 13.25 30.1253 13.25C30.0432 13.25 29.9619 13.2662 29.886 13.2976C29.8101 13.3291 29.7412 13.3752 29.6832 13.4333L27.4644 15.6528L27.0449 15.2325C26.5755 14.7645 25.9397 14.5017 25.2769 14.5017C24.6141 14.5017 23.9783 14.7645 23.5089 15.2325L21.6878 17.0544L21.1925 16.5583C21.0753 16.441 20.9162 16.3751 20.7503 16.3751C20.5845 16.3751 20.4254 16.441 20.3082 16.5583C20.1909 16.6756 20.125 16.8346 20.125 17.0005C20.125 17.1663 20.1909 17.3254 20.3082 17.4427L26.5582 23.6927C26.6162 23.7507 26.6852 23.7968 26.761 23.8282C26.8369 23.8597 26.9182 23.8758 27.0003 23.8758C27.0825 23.8758 27.1638 23.8597 27.2397 23.8282C27.3155 23.7968 27.3845 23.7507 27.4425 23.6927C27.5006 23.6346 27.5467 23.5657 27.5781 23.4898C27.6095 23.4139 27.6257 23.3326 27.6257 23.2505C27.6257 23.1684 27.6095 23.0871 27.5781 23.0112C27.5467 22.9353 27.5006 22.8664 27.4425 22.8083L26.9464 22.313L28.7683 20.4919C29.0005 20.2597 29.1847 19.9841 29.3104 19.6808C29.4361 19.3774 29.5008 19.0523 29.5008 18.7239C29.5008 18.3956 29.4361 18.0704 29.3104 17.7671C29.1847 17.4637 29.0005 17.1881 28.7683 16.956L28.348 16.5364L30.5675 14.3177C30.6256 14.2596 30.6717 14.1907 30.7032 14.1148C30.7347 14.039 30.7508 13.9576 30.7508 13.8755C30.7508 13.7934 30.7347 13.712 30.7032 13.6362C30.6717 13.5603 30.6256 13.4913 30.5675 13.4333ZM27.8839 19.6052L26.0628 21.4294L22.5714 17.938L24.3933 16.1169C24.6277 15.8827 24.9455 15.7511 25.2769 15.7511C25.6083 15.7511 25.9261 15.8827 26.1605 16.1169L27.8839 17.8356C28.0006 17.9518 28.0932 18.0899 28.1564 18.2419C28.2196 18.3939 28.2521 18.5569 28.2521 18.7216C28.2521 18.8862 28.2196 19.0492 28.1564 19.2013C28.0932 19.3533 28.0006 19.4914 27.8839 19.6075V19.6052Z"
        fill="currentColor"
      />
    </svg>
  );
}

function IntegrationIcon({ type }: { type: DataSourceIntegrationModel['type'] }) {
  switch (type) {
    case 'notion':
      return <NotionIcon />;

    default:
      return null;
  }
}
